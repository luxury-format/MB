{{ $pages := .Site.Pages }}
{{ with site.GetPage "page" "archive" }}
  {{ $pages = union $pages (slice .) }}
{{ end }}
{{ $pages = where $pages "Title" "ne" "" }}
{{ $sorted := sort $pages "Permalink" }}
{{ if gt (len $sorted) 0 }}
<ul class="allpages">
  {{ range $sorted }}
    {{ if and (ne .Title $.Site.Title) (not (in .Permalink "magic/preview/")) }}
      <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
    {{ end }}
  {{ end }}
</ul>
{{ end }}